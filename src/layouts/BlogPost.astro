---
import { Image } from "astro:assets";
import type { CollectionEntry } from "astro:content";
import BaseLayout from "./BaseLayout.astro";

type Props = CollectionEntry<"blog">["data"];

const { title, description, pubDate, updatedDate, heroImage, tags = [] } = Astro.props as Props;
const isPublicHeroImage = typeof heroImage === "string";
const base = import.meta.env.BASE_URL.endsWith("/")
  ? import.meta.env.BASE_URL
  : `${import.meta.env.BASE_URL}/`;
const withBase = (value = "") => {
  const normalized = value.replace(/^\/+/, "");
  return normalized ? `${base}${normalized}` : base;
};
const heroImageSrc =
  isPublicHeroImage && heroImage.startsWith("/") ? withBase(heroImage) : heroImage;

const formatDate = (date: Date) =>
  new Intl.DateTimeFormat("ja-JP", {
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
  }).format(date);
---

<BaseLayout title={title} description={description}>
  <article class="article">
    {
      heroImage && (
        <figure class="card article-hero">
          {
            isPublicHeroImage ? (
              <img src={heroImageSrc} alt={title} loading="eager" decoding="async" />
            ) : (
              <Image width={1200} height={630} src={heroImage} alt={title} />
            )
          }
        </figure>
      )
    }

    <header class="card article-head">
      <p class="meta article-date">
        公開日: {formatDate(pubDate)}
        {updatedDate && ` · 更新日: ${formatDate(updatedDate)}`}
      </p>
      <h1>{title}</h1>
      {
        tags.length > 0 && (
          <ul class="article-tags" aria-label="Post tags">
            {tags.map((tag) => <li class="article-tag">{tag}</li>)}
          </ul>
        )
      }
      <p class="meta">{description}</p>
    </header>

    <section class="card prose article-prose">
      <slot />
    </section>
  </article>
</BaseLayout>
